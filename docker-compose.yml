# ==========================================
# Block Flow Docker Compose 配置文件
# ==========================================
# 使用方法：
#   启动: docker-compose up -d
#   停止: docker-compose down
#   查看日志: docker-compose logs -f block-flow-api
#   重启: docker-compose restart
# ==========================================

version: '3.8'
services:
  block-flow-api:
    # 重启策略
    restart: unless-stopped
    image: tannnn/block-flow:latest
    container_name: block-flow
    # 构建配置（如需本地构建，取消注释）
    # build:
    #   context: .
    #   dockerfile: api/Dockerfile
    ports:
      - "${HOST_PORT:-1250}:1250"
    environment:
      # 时区配置
      TZ: Asia/Shanghai

      # 运行环境配置
      CONFIG_ENV: ${CONFIG_ENV:-prod}
      SPRING_PROFILES_ACTIVE: ${CONFIG_ENV:-prod}

      # 文件上传配置
      FILE_MAX_SIZE: ${FILE_MAX_SIZE:-2GB}
      FILE_MAX_REQUEST: ${FILE_MAX_REQUEST:-2GB}

      # Python 环境配置
      PYTHON_ENV_ROOT_PATH: ${PYTHON_ENV_ROOT_PATH:-/app/python-envs}

      # Swagger API 文档认证
      DOC_USERNAME: ${DOC_USERNAME:-tan}
      DOC_PASSWORD: ${DOC_PASSWORD:-tan}

      # MySQL 数据库配置
      MYSQL_URL: ${MYSQL_URL:-localhost:3306}
      MYSQL_DB: ${MYSQL_DB:-db_block_flow}
      MYSQL_UNM: ${MYSQL_UNM:-root}
      MYSQL_PWD: ${MYSQL_PWD:-root}

      # JVM 配置
      JAVA_OPTS: ${JAVA_OPTS:--Xms256m -Xmx512m}
    volumes:
      # 数据持久化
      - ${DATA_PATH:-./data}:/app/data
      # 日志持久化
      - ${LOGS_PATH:-./logs}:/app/logs
      # Python 环境持久化（展示不持久化，需要迁移的化自己重新上传后修改块的环境数据（或者创建一个一样id的环境
#      - ${PYTHON_ENVS_PATH:-./python-envs}:/app/python-envs
    # 资源限制
    deploy:
      resources:
        limits:
          cpus: ${CPU_LIMIT:-1}
          memory: ${MEMORY_LIMIT:-2G}
        reservations:
          cpus: ${CPU_RESERVATION:-1}
          memory: ${MEMORY_RESERVATION:-1G}

    # 网络配置
    networks:
      - block-flow-network

# ==========================================
# 可选：MySQL 数据库服务
# 如需使用 MySQL 数据库，取消以下注释
# 注意：需要同时修改 block-flow-api 的 MYSQL_URL 为 mysql:3306
# ==========================================
#  mysql:
#    image: mysql:8.0
#    container_name: block-flow-mysql
#    environment:
#      TZ: Asia/Shanghai
#      MYSQL_ROOT_PASSWORD: ${MYSQL_PWD:-root}
#      MYSQL_DATABASE: ${MYSQL_DB:-db_block_flow}
#      MYSQL_USER: ${MYSQL_UNM:-root}
#      MYSQL_PASSWORD: ${MYSQL_PWD:-root}
#    volumes:
#      - mysql-data:/var/lib/mysql
#      - ./api/doc/init.sql:/docker-entrypoint-initdb.d/01-init.sql:ro
#      - ./api/doc/init_block.sql:/docker-entrypoint-initdb.d/02-init_block.sql:ro
#      - ./api/doc/init_context.sql:/docker-entrypoint-initdb.d/03-init_context.sql:ro
#      - ./api/doc/init_workflows.sql:/docker-entrypoint-initdb.d/04-init_workflows.sql:ro
#    ports:
#      - "${MYSQL_PORT:-3306}:3306"
#    command: --default-authentication-plugin=mysql_native_password --default-time-zone='+8:00'
#    restart: unless-stopped
#    networks:
#      - block-flow-network

networks:
  block-flow-network:
    driver: bridge

# ==========================================
# 数据卷配置（如启用 MySQL）
# ==========================================
#volumes:
#  mysql-data:
